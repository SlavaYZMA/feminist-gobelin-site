<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цифровой Гобелен</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        canvas { position: absolute; top: 0; left: 0; z-index: -1; }
        .container { position: relative; z-index: 1; }
        body { overflow: hidden; background: transparent; }
        .glass { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        function GobelinApp() {
            const [userId] = React.useState('user_' + Math.random().toString(36).substr(2, 9));
            const [name, setName] = React.useState(localStorage.getItem('name') || '');
            const [country, setCountry] = React.useState(localStorage.getItem('country') || '');
            const [city, setCity] = React.useState(localStorage.getItem('city') || '');
            const [language, setLanguage] = React.useState(localStorage.getItem('language') || '');
            const [prompt, setPrompt] = React.useState('');
            const [response, setResponse] = React.useState('');
            const [showDetails, setShowDetails] = React.useState(false);
            const canvasRef = React.useRef(null);

            // Сохранение данных в localStorage
            React.useEffect(() => {
                localStorage.setItem('name', name);
                localStorage.setItem('country', country);
                localStorage.setItem('city', city);
                localStorage.setItem('language', language);
            }, [name, country, city, language]);

            // Функция для рисования нити
            const drawThread = (ctx, length, color, thickness, material) => {
                console.log(`Нить: длина ${length}px, цвет ${color}, толщина ${thickness}px, материал ${material}`);
                ctx.beginPath();
                const startX = Math.random() * ctx.canvas.width;
                ctx.moveTo(startX, 0);
                ctx.lineTo(startX, length);
                ctx.strokeStyle = color;
                ctx.lineWidth = thickness;
                if (material === 'silk') {
                    ctx.setLineDash([5, 5]);
                } else if (material === 'wool') {
                    ctx.setLineDash([10, 2]);
                } else {
                    ctx.setLineDash([]);
                }
                ctx.stroke();
            };

            // Инициализация canvas
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // Начальные нити
                for (let i = 0; i < 10; i++) {
                    drawThread(
                        ctx,
                        Math.random() * canvas.height,
                        `hsl(${Math.random() * 360}, 70%, 50%)`,
                        Math.random() * 5 + 1,
                        ['cotton', 'silk', 'wool'][Math.floor(Math.random() * 3)]
                    );
                }
            }, []);

            // Обработка отправки запроса
            const handleSubmit = async () => {
                try {
                    const response = await fetch('https://SlavaYZMA-feminist-gobelin-server.hf.space/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, name, country, city, language, prompt }),
                        signal: AbortSignal.timeout(30000)
                    });
                    if (!response.ok) {
                        throw new Error('Сервер не отвечает');
                    }
                    const data = await response.json();
                    if (data.error) {
                        setResponse(`Ошибка: ${data.error}`);
                    } else {
                        setResponse(data.response);
                    }

                    // Новая нить
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const length = Math.min(prompt.length * 10, canvas.height);
                    const color = prompt.includes('Феминизм') ? 'red' : 
                                 prompt.includes('Feminism') ? 'blue' : 
                                 prompt.includes('El feminismo') ? 'green' : 'purple';
                    const thickness = Math.min(prompt.length / 2, 10);
                    const material = prompt.length < 20 ? 'cotton' : 
                                    prompt.length < 40 ? 'silk' : 'wool';
                    drawThread(ctx, length, color, thickness, material);
                } catch (error) {
                    console.error('Ошибка:', error);
                    setResponse('Ошибка при запросе к ИИ');
                }
            };

            return (
                <div className="container max-w-md mx-auto p-4 glass rounded-lg">
                    <h1 className="text-2xl font-bold text-center mb-4 text-gray-800">Цифровой Гобелен</h1>
                    <div className="flex items-center mb-4">
                        <input
                            type="text"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="Задай вопрос ИИ (например, Куда обратиться?)"
                            className="w-full p-2 bg-transparent border border-gray-300 text-gray-800 rounded-l focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <button
                            onClick={handleSubmit}
                            className="p-2 bg-purple-500 rounded-r hover:bg-purple-600"
                            title="Отправить"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                    <button
                        onClick={() => setShowDetails(!showDetails)}
                        className="text-gray-800 text-sm mb-4 hover:underline"
                    >
                        {showDetails ? 'скрыть ↑' : 'уточнить данные ↓'}
                    </button>
                    {showDetails && (
                        <div className="space-y-2 mb-4">
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="Имя (например, Анна)"
                                className="w-full p-2 bg-transparent border border-gray-300 text-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <input
                                type="text"
                                value={country}
                                onChange={(e) => setCountry(e.target.value)}
                                placeholder="Страна (например, Испания)"
                                className="w-full p-2 bg-transparent border border-gray-300 text-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <input
                                type="text"
                                value={city}
                                onChange={(e) => setCity(e.target.value)}
                                placeholder="Город (например, Мадрид)"
                                className="w-full p-2 bg-transparent border border-gray-300 text-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <input
                                type="text"
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                placeholder="Язык общения (например, Русский)"
                                className="w-full p-2 bg-transparent border border-gray-300 text-gray-800 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                        </div>
                    )}
                    {response && (
                        <div className="p-2 bg-transparent border border-gray-300 text-gray-800 rounded">
                            <p><strong>Ответ:</strong> {response}</p>
                        </div>
                    )}
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        ReactDOM.render(<GobelinApp />, document.getElementById('root'));
    </script>
</body>
</html>
