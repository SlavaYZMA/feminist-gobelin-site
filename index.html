<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цифровой Гобелен</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6; /* Фиолетовый */
            --accent: #ec4899; /* Розовый */
            --text: #e5e7eb; /* Светло-серый */
            --background: rgba(255, 255, 255, 0.1);
        }
        body {
            background: linear-gradient(to bottom, #f3e8ff, #fce7f3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            scroll-behavior: smooth;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text);
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100vh;
        }
        .container {
            display: grid;
            gap: 1.5rem;
            max-width: 32rem;
            width: 100%;
            padding: 2rem;
            margin: 2rem;
            background: var(--background);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-radius: 1rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .details {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .details.open {
            max-height: 600px;
            opacity: 1;
        }
        .input-group {
            background: linear-gradient(to right, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--primary);
            border-opacity: 0.5;
            display: flex;
            align-items: center;
            height: 2.5rem;
        }
        input, select {
            transition: all 0.2s ease;
            appearance: none;
            border: none;
            background: transparent;
            height: 2.5rem;
            font-size: 1rem;
            padding: 0 0.75rem;
            color: var(--text);
        }
        button {
            transition: all 0.2s ease;
        }
        .modal {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .modal-content {
            background: var(--background);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 24rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        @media (prefers-color-scheme: dark) {
            .container, .modal-content { background: rgba(0, 0, 0, 0.25); }
            .input-group { background: linear-gradient(to right, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2)); }
        }
        @media (max-width: 640px) {
            .container { padding: 1rem; margin: 1rem; }
            .input-group, input, select { height: 2.25rem; }
            input, select { font-size: 0.875rem; padding: 0 0.5rem; }
            button { font-size: 0.875rem; padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function GobelinApp() {
            const [userId] = React.useState('user_' + Math.random().toString(36).substr(2, 9));
            const [name, setName] = React.useState(localStorage.getItem('name') || '');
            const [country, setCountry] = React.useState(localStorage.getItem('country') || '');
            const [city, setCity] = React.useState(localStorage.getItem('city') || '');
            const [language, setLanguage] = React.useState(localStorage.getItem('language') || 'Русский');
            const [prompt, setPrompt] = React.useState('');
            const [response, setResponse] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [showDetails, setShowDetails] = React.useState(false);
            const [showAbout, setShowAbout] = React.useState(false);
            const [history, setHistory] = React.useState(JSON.parse(localStorage.getItem('history') || '[]'));
            const canvasRef = React.useRef(null);
            const threadsRef = React.useRef([]);

            // Локализация
            const translations = {
                ru: {
                    title: 'Цифровой Гобелен',
                    about: 'О проекте',
                    aboutText: 'Цифровой Гобелен — это арт-проект и чат-бот для поддержки женщин-мигранток, столкнувшихся с насилием. Задавайте вопросы, чтобы получить помощь, психологическую поддержку или советы.',
                    promptPlaceholder: 'Задай вопрос (например, Куда обратиться?)',
                    details: 'Уточнить данные',
                    hide: 'Скрыть ↑',
                    name: 'Имя (например, Анна)',
                    country: 'Выберите страну',
                    city: 'Город (например, Мадрид)',
                    language: 'Выберите язык',
                    reset: 'Сбросить данные',
                    retry: 'Попробовать снова',
                    history: 'История запросов',
                    question: 'Вопрос:',
                    answer: 'Ответ:',
                    error: 'Ошибка: Введите вопрос для ИИ.',
                    serverError: 'Сервер не отвечает. Проверьте соединение или попробуйте позже.',
                    submit: 'Отправить'
                },
                uk: {
                    title: 'Цифровий Гобелен',
                    about: 'Про проєкт',
                    aboutText: 'Цифровий Гобелен — це арт-проєкт і чат-бот для підтримки жінок-мігранток, які зіткнулися з насильством. Задавайте питання, щоб отримати допомогу або поради.',
                    promptPlaceholder: 'Задайте питання (наприклад, Куди звернутися?)',
                    details: 'Уточнити дані',
                    hide: 'Приховати ↑',
                    name: "Ім'я (наприклад, Анна)",
                    country: 'Виберіть країну',
                    city: 'Місто (наприклад, Мадрид)',
                    language: 'Виберіть мову',
                    reset: 'Скинути дані',
                    retry: 'Спробувати ще раз',
                    history: 'Історія запитів',
                    question: 'Питання:',
                    answer: 'Відповідь:',
                    error: 'Помилка: Введіть питання для ШІ.',
                    serverError: 'Сервер не відповідає. Перевірте з’єднання або спробуйте пізніше.',
                    submit: 'Надіслати'
                },
                en: {
                    title: 'Digital Tapestry',
                    about: 'About the Project',
                    aboutText: 'Digital Tapestry is an art project and chatbot to support migrant women facing violence. Ask questions to get help, psychological support, or advice.',
                    promptPlaceholder: 'Ask a question (e.g., Where to seek help?)',
                    details: 'Refine details',
                    hide: 'Hide ↑',
                    name: 'Name (e.g., Anna)',
                    country: 'Select country',
                    city: 'City (e.g., Madrid)',
                    language: 'Select language',
                    reset: 'Reset data',
                    retry: 'Try again',
                    history: 'Request history',
                    question: 'Question:',
                    answer: 'Answer:',
                    error: 'Error: Please enter a question for the AI.',
                    serverError: 'Server not responding. Check connection or try again later.',
                    submit: 'Submit'
                },
                sr: {
                    title: 'Digitalni Goblen',
                    about: 'O projektu',
                    aboutText: 'Digitalni Goblen je umetnički projekat i čet-bot za podršku ženama migrantkinjama koje se suočavaju sa nasiljem. Postavljajte pitanja za pomoć ili savete.',
                    promptPlaceholder: 'Postavite pitanje (npr. Gde potražiti pomoć?)',
                    details: 'Precizirajte podatke',
                    hide: 'Sakrij ↑',
                    name: 'Ime (npr. Ana)',
                    country: 'Izaberite zemlju',
                    city: 'Grad (npr. Madrid)',
                    language: 'Izaberite jezik',
                    reset: 'Resetuj podatke',
                    retry: 'Pokušaj ponovo',
                    history: 'Istorija zahteva',
                    question: 'Pitanje:',
                    answer: 'Odgovor:',
                    error: 'Greška: Unesite pitanje za AI.',
                    serverError: 'Server ne odgovara. Proverite vezu ili pokušajte ponovo.',
                    submit: 'Pošalji'
                },
                de: {
                    title: 'Digitaler Wandteppich',
                    about: 'Über das Projekt',
                    aboutText: 'Digitaler Wandteppich ist ein Kunstprojekt und Chatbot zur Unterstützung von Migrantinnen, die mit Gewalt konfrontiert sind. Stellen Sie Fragen, um Hilfe oder Ratschläge zu erhalten.',
                    promptPlaceholder: 'Stellen Sie eine Frage (z.B. Wo kann ich Hilfe suchen?)',
                    details: 'Details verfeinern',
                    hide: 'Verbergen ↑',
                    name: 'Name (z.B. Anna)',
                    country: 'Land auswählen',
                    city: 'Stadt (z.B. Madrid)',
                    language: 'Sprache auswählen',
                    reset: 'Daten zurücksetzen',
                    retry: 'Erneut versuchen',
                    history: 'Anfragengeschichte',
                    question: 'Frage:',
                    answer: 'Antwort:',
                    error: 'Fehler: Bitte geben Sie eine Frage für die KI ein.',
                    serverError: 'Server antwortet nicht. Überprüfen Sie die Verbindung oder versuchen Sie es später erneut.',
                    submit: 'Senden'
                }
            };

            // Список стран и городов
            const countries = [
                'Испания', 'Германия', 'Россия', 'Франция', 'Украина', 'Сербия', 'Великобритания'
            ];
            const citiesByCountry = {
                'Испания': ['Мадрид', 'Барселона', 'Валенсия'],
                'Германия': ['Берлин', 'Мюнхен', 'Гамбург'],
                'Россия': ['Москва', 'Санкт-Петербург', 'Новосибирск'],
                'Франция': ['Париж', 'Марсель', 'Лион'],
                'Украина': ['Киев', 'Одесса', 'Львов'],
                'Сербия': ['Белград', 'Нови-Сад', 'Ниш'],
                'Великобритания': ['Лондон', 'Манчестер', 'Бирмингем']
            };
            const languages = ['Русский', 'Украинский', 'Английский', 'Сербский', 'Немецкий'];

            // Сохранение данных
            React.useEffect(() => {
                localStorage.setItem('name', name);
                localStorage.setItem('country', country);
                localStorage.setItem('city', city);
                localStorage.setItem('language', language);
                localStorage.setItem('history', JSON.stringify(history.slice(-5)));
            }, [name, country, city, language, history]);

            // Рисование реалистичной нити
            const drawThread = (ctx, prompt) => {
                const length = Math.min(prompt.length * 15, ctx.canvas.height);
                const isHorizontal = Math.random() > 0.5;
                const colors = ['#8b5cf6', '#ec4899', '#f472b6', '#3b82f6'];
                const color = prompt.includes('насилие') || prompt.includes('violence') ? '#ec4899' :
                             prompt.includes('поддержка') || prompt.includes('support') ? '#3b82f6' : '#8b5cf6';
                const thickness = Math.min(prompt.length / 3, 8);
                const material = prompt.length < 20 ? 'cotton' :
                                prompt.length < 40 ? 'silk' : 'wool';
                const padding = 100;
                const startX = isHorizontal ? padding : Math.random() * (ctx.canvas.width - 2 * padding) + padding;
                const startY = isHorizontal ? Math.random() * (ctx.canvas.height - 2 * padding) + padding : padding;
                const endX = isHorizontal ? ctx.canvas.width - padding : startX;
                const endY = isHorizontal ? startY : length + padding;
                const controlX = (startX + endX) / 2 + (Math.random() - 0.5) * 100;
                const controlY = (startY + endY) / 2 + (Math.random() - 0.5) * 100;

                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.quadraticCurveTo(controlX, controlY, endX, endY);
                ctx.strokeStyle = color;
                ctx.lineWidth = thickness;
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.globalAlpha = material === 'silk' ? 0.8 : material === 'wool' ? 0.6 : 1;
                if (material === 'silk') {
                    ctx.setLineDash([5, 5]);
                } else if (material === 'wool') {
                    ctx.setLineDash([10, 2]);
                } else {
                    ctx.setLineDash([]);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;
                threadsRef.current.push({ startX, startY, endX, endY, controlX, controlY, color, thickness, material });
                if (threadsRef.current.length > 50) {
                    threadsRef.current.shift();
                    redrawCanvas(ctx);
                }
            };

            // Очистка и перерисовка canvas
            const redrawCanvas = (ctx) => {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                threadsRef.current.forEach(({ startX, startY, endX, endY, controlX, controlY, color, thickness, material }) => {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.quadraticCurveTo(controlX, controlY, endX, endY);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = thickness;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                    ctx.globalAlpha = material === 'silk' ? 0.8 : material === 'wool' ? 0.6 : 1;
                    if (material === 'silk') {
                        ctx.setLineDash([5, 5]);
                    } else if (material === 'wool') {
                        ctx.setLineDash([10, 2]);
                    } else {
                        ctx.setLineDash([]);
                    }
                    ctx.stroke();
                });
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;
            };

            // Инициализация canvas
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // Начальные нити
                for (let i = 0; i < 10; i++) {
                    drawThread(ctx, 'Начальная нить ' + i);
                }
            }, []);

            // Обработка отправки запроса
            const handleSubmit = async () => {
                if (!prompt) {
                    setResponse(translations[language.toLowerCase()]?.error || 'Ошибка: Введите вопрос для ИИ.');
                    return;
                }
                setIsLoading(true);
                try {
                    const response = await fetch('https://SlavaYZMA-feminist-gobelin-server.hf.space/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, name, country, city, language, prompt }),
                        signal: AbortSignal.timeout(30000)
                    });
                    if (!response.ok) {
                        throw new Error(translations[language.toLowerCase()]?.serverError || 'Сервер не отвечает. Проверьте соединение или попробуйте позже.');
                    }
                    const data = await response.json();
                    if (data.error) {
                        setResponse(`Ошибка: ${data.error}`);
                    } else {
                        setResponse(data.response);
                        setHistory([...history, { prompt, response: data.response }]);
                    }

                    // Новая нить
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    drawThread(ctx, prompt);
                } catch (error) {
                    console.error('Ошибка:', error);
                    setResponse(`Ошибка: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // Сброс данных
            const resetData = () => {
                setName('');
                setCountry('');
                setCity('');
                setLanguage('Русский');
                setHistory([]);
                localStorage.removeItem('name');
                localStorage.removeItem('country');
                localStorage.removeItem('city');
                localStorage.setItem('language', 'Русский');
                localStorage.removeItem('history');
            };

            return (
                <div className="container">
                    <header className="flex justify-between items-center">
                        <h1 className="text-2xl font-semibold text-[var(--text)]">{translations[language.toLowerCase()]?.title || 'Цифровой Гобелен'}</h1>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => setShowAbout(true)}
                                className="text-sm text-[var(--primary)] hover:underline"
                            >
                                {translations[language.toLowerCase()]?.about || 'О проекте'}
                            </button>
                            <select
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                className="p-1 bg-transparent text-[var(--text)] border border-[var(--primary)] border-opacity-50 rounded"
                            >
                                {languages.map((lang) => (
                                    <option key={lang} value={lang}>{lang}</option>
                                ))}
                            </select>
                        </div>
                    </header>
                    {showAbout && (
                        <div className="modal">
                            <div className="modal-content">
                                <h2 className="text-lg font-semibold text-[var(--text)] mb-2">{translations[language.toLowerCase()]?.about || 'О проекте'}</h2>
                                <p className="text-sm text-[var(--text)]">{translations[language.toLowerCase()]?.aboutText || 'Цифровой Гобелен — это арт-проект и чат-бот для поддержки женщин-мигранток.'}</p>
                                <button
                                    onClick={() => setShowAbout(false)}
                                    className="mt-4 text-sm text-[var(--primary)] hover:underline"
                                >
                                    Закрыть
                                </button>
                            </div>
                        </div>
                    )}
                    <div className="input-group">
                        <label htmlFor="prompt" className="sr-only">{translations[language.toLowerCase()]?.promptPlaceholder || 'Вопрос для ИИ'}</label>
                        <input
                            id="prompt"
                            type="text"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder={translations[language.toLowerCase()]?.promptPlaceholder || 'Задай вопрос (например, Куда обратиться?)'}
                            className="w-full p-2 text-[var(--text)] focus:outline-none"
                            onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                        />
                        <button
                            onClick={handleSubmit}
                            disabled={isLoading}
                            aria-label={translations[language.toLowerCase()]?.submit || 'Отправить'}
                            className={`p-2 bg-gradient-to-r from-[var(--primary)] to-[var(--accent)] rounded-r-lg hover:shadow-lg text-[var(--text)] font-medium ${isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'}`}
                        >
                            {isLoading ? '...' : translations[language.toLowerCase()]?.submit || 'Отправить'}
                        </button>
                    </div>
                    <div className="text-center">
                        <button
                            onClick={() => setShowDetails(!showDetails)}
                            aria-expanded={showDetails}
                            className="text-sm text-[var(--primary)] hover:underline"
                        >
                            {showDetails ? translations[language.toLowerCase()]?.hide || 'Скрыть ↑' : translations[language.toLowerCase()]?.details || 'Уточнить данные ↓'}
                        </button>
                        <p className="text-xs text-gray-400 mt-1">{translations[language.toLowerCase()]?.details || 'Для более точных ответов'}</p>
                    </div>
                    {showDetails && (
                        <div className="details open space-y-3">
                            <div className="input-group">
                                <label htmlFor="name" className="sr-only">{translations[language.toLowerCase()]?.name || 'Имя'}</label>
                                <input
                                    id="name"
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder={translations[language.toLowerCase()]?.name || 'Имя (например, Анна)'}
                                    className="w-full p-2 text-[var(--text)] rounded focus:outline-none"
                                />
                            </div>
                            <div className="input-group">
                                <label htmlFor="country" className="sr-only">{translations[language.toLowerCase()]?.country || 'Страна'}</label>
                                <select
                                    id="country"
                                    value={country}
                                    onChange={(e) => { setCountry(e.target.value); setCity(''); }}
                                    className="w-full p-2 text-[var(--text)] rounded focus:outline-none"
                                >
                                    <option value="">{translations[language.toLowerCase()]?.country || 'Выберите страну'}</option>
                                    {countries.map((c) => (
                                        <option key={c} value={c}>{c}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="input-group">
                                <label htmlFor="city" className="sr-only">{translations[language.toLowerCase()]?.city || 'Город'}</label>
                                <select
                                    id="city"
                                    value={city}
                                    onChange={(e) => setCity(e.target.value)}
                                    className="w-full p-2 text-[var(--text)] rounded focus:outline-none"
                                    disabled={!country}
                                >
                                    <option value="">{translations[language.toLowerCase()]?.city || 'Город (например, Мадрид)'}</option>
                                    {(citiesByCountry[country] || []).map((c) => (
                                        <option key={c} value={c}>{c}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="input-group">
                                <label htmlFor="language" className="sr-only">{translations[language.toLowerCase()]?.language || 'Язык'}</label>
                                <select
                                    id="language"
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    className="w-full p-2 text-[var(--text)] rounded focus:outline-none"
                                >
                                    <option value="">{translations[language.toLowerCase()]?.language || 'Выберите язык'}</option>
                                    {languages.map((lang) => (
                                        <option key={lang} value={lang}>{lang}</option>
                                    ))}
                                </select>
                            </div>
                            <button
                                onClick={resetData}
                                className="text-sm text-[var(--primary)] hover:underline"
                            >
                                {translations[language.toLowerCase()]?.reset || 'Сбросить данные'}
                            </button>
                        </div>
                    )}
                    {response && (
                        <div className="p-4 bg-[var(--background)] border border-[var(--primary)] border-opacity-50 rounded-lg shadow-md">
                            <p className="text-[var(--text)]"><strong>{translations[language.toLowerCase()]?.answer || 'Ответ:'}</strong> {response}</p>
                            {response.includes('Ошибка') && (
                                <button
                                    onClick={handleSubmit}
                                    className="text-sm text-[var(--primary)] hover:underline mt-2"
                                >
                                    {translations[language.toLowerCase()]?.retry || 'Попробовать снова'}
                                </button>
                            )}
                        </div>
                    )}
                    {history.length > 0 && (
                        <div className="p-4 bg-[var(--background)] border border-[var(--primary)] border-opacity-50 rounded-lg shadow-md">
                            <h2 className="text-lg font-semibold text-[var(--text)] mb-2">{translations[language.toLowerCase()]?.history || 'История запросов'}</h2>
                            {history.slice(-5).reverse().map((item, index) => (
                                <div key={index} className="text-sm text-[var(--text)] mb-2">
                                    <p><strong>{translations[language.toLowerCase()]?.question || 'Вопрос:'}</strong> {item.prompt}</p>
                                    <p><strong>{translations[language.toLowerCase()]?.answer || 'Ответ:'}</strong> {item.response}</p>
                                </div>
                            ))}
                        </div>
                    )}
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        ReactDOM.render(<GobelinApp />, document.getElementById('root'));
    </script>
</body>
</html>
