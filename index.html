<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цифровой Гобелен</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --accent: #ec4899;
            --neutral: #111827;
        }
        canvas { position: absolute; top: 0; left: 0; z-index: -1; }
        .container { position: relative; z-index: 1; }
        body { overflow: hidden; background: transparent; }
        .glass { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .details {
            transition: max-height 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .details.open {
            max-height: 500px;
        }
        @media (prefers-color-scheme: dark) {
            .glass { background: rgba(0, 0, 0, 0.2); }
            .text-neutral { color: #f3f4f6; }
        }
        @media (max-width: 640px) {
            button svg { height: 2rem; width: 2rem; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        // Для продакшена: Используйте Vite/Webpack для прекомпиляции React
        function GobelinApp() {
            const [userId] = React.useState('user_' + Math.random().toString(36).substr(2, 9));
            const [name, setName] = React.useState(localStorage.getItem('name') || '');
            const [country, setCountry] = React.useState(localStorage.getItem('country') || '');
            const [city, setCity] = React.useState(localStorage.getItem('city') || '');
            const [language, setLanguage] = React.useState(localStorage.getItem('language') || '');
            const [prompt, setPrompt] = React.useState('');
            const [response, setResponse] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [showDetails, setShowDetails] = React.useState(false);
            const [history, setHistory] = React.useState(JSON.parse(localStorage.getItem('history') || '[]'));
            const canvasRef = React.useRef(null);
            const threadsRef = React.useRef([]);

            // Сохранение данных в localStorage
            React.useEffect(() => {
                localStorage.setItem('name', name);
                localStorage.setItem('country', country);
                localStorage.setItem('city', city);
                localStorage.setItem('language', language);
                localStorage.setItem('history', JSON.stringify(history.slice(-5)));
            }, [name, country, city, language, history]);

            // Функция для рисования нити
            const drawThread = (ctx, length, color, thickness, material) => {
                console.log(`Нить: длина ${length}px, цвет ${color}, толщина ${thickness}px, материал ${material}`);
                ctx.beginPath();
                const startX = Math.random() * ctx.canvas.width;
                ctx.moveTo(startX, 0);
                ctx.lineTo(startX, length);
                ctx.strokeStyle = color;
                ctx.lineWidth = thickness;
                if (material === 'silk') {
                    ctx.setLineDash([5, 5]);
                } else if (material === 'wool') {
                    ctx.setLineDash([10, 2]);
                } else {
                    ctx.setLineDash([]);
                }
                ctx.stroke();
                threadsRef.current.push({ length, color, thickness, material, startX });
                if (threadsRef.current.length > 50) {
                    threadsRef.current.shift();
                    redrawCanvas(ctx);
                }
            };

            // Очистка и перерисовка canvas
            const redrawCanvas = (ctx) => {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                threadsRef.current.forEach(({ length, color, thickness, material, startX }) => {
                    ctx.beginPath();
                    ctx.moveTo(startX, 0);
                    ctx.lineTo(startX, length);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = thickness;
                    if (material === 'silk') {
                        ctx.setLineDash([5, 5]);
                    } else if (material === 'wool') {
                        ctx.setLineDash([10, 2]);
                    } else {
                        ctx.setLineDash([]);
                    }
                    ctx.stroke();
                });
            };

            // Инициализация canvas
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // Начальные нити
                const colors = ['#8b5cf6', '#ec4899', '#3b82f6'];
                for (let i = 0; i < 10; i++) {
                    drawThread(
                        ctx,
                        Math.random() * canvas.height,
                        colors[Math.floor(Math.random() * colors.length)],
                        Math.random() * 5 + 1,
                        ['cotton', 'silk', 'wool'][Math.floor(Math.random() * 3)]
                    );
                }
            }, []);

            // Обработка отправки запроса
            const handleSubmit = async () => {
                if (!prompt) {
                    setResponse('Ошибка: Введите вопрос для ИИ.');
                    return;
                }
                setIsLoading(true);
                try {
                    const response = await fetch('https://SlavaYZMA-feminist-gobelin-server.hf.space/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, name, country, city, language, prompt }),
                        signal: AbortSignal.timeout(30000)
                    });
                    if (!response.ok) {
                        throw new Error('Сервер не отвечает. Проверьте соединение.');
                    }
                    const data = await response.json();
                    if (data.error) {
                        setResponse(`Ошибка: ${data.error}`);
                    } else {
                        setResponse(data.response);
                        setHistory([...history, { prompt, response: data.response }]);
                    }

                    // Новая нить
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const length = Math.min(prompt.length * 10, canvas.height);
                    const color = prompt.includes('Феминизм') ? '#ec4899' : 
                                 prompt.includes('Feminism') ? '#3b82f6' : 
                                 prompt.includes('El feminismo') ? '#10b981' : '#8b5cf6';
                    const thickness = Math.min(prompt.length / 2, 10);
                    const material = prompt.length < 20 ? 'cotton' : 
                                    prompt.length < 40 ? 'silk' : 'wool';
                    drawThread(ctx, length, color, thickness, material);
                } catch (error) {
                    console.error('Ошибка:', error);
                    setResponse(`Ошибка: ${error.message}. Попробуйте позже.`);
                } finally {
                    setIsLoading(false);
                }
            };

            // Сброс данных
            const resetData = () => {
                setName('');
                setCountry('');
                setCity('');
                setLanguage('');
                localStorage.removeItem('name');
                localStorage.removeItem('country');
                localStorage.removeItem('city');
                localStorage.removeItem('language');
            };

            return (
                <div className="container w-full max-w-lg mx-auto p-4 sm:p-6 md:p-8 glass rounded-lg">
                    <h1 className="text-3xl font-bold text-center mb-2 text-neutral">Цифровой Гобелен</h1>
                    <p className="text-sm text-gray-600 text-center mb-4">Задайте вопрос о феминизме или поддержке</p>
                    <div className="flex items-center mb-4">
                        <label htmlFor="prompt" className="sr-only">Вопрос для ИИ</label>
                        <div className="flex items-center w-full bg-transparent border border-gray-400 rounded-l focus-within:ring-2 focus-within:ring-purple-500">
                            <svg className="h-5 w-5 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-4a2 2 0 012-2h10a2 2 0 012 2v4h-4m-2 4h.01" />
                            </svg>
                            <input
                                id="prompt"
                                type="text"
                                value={prompt}
                                onChange={(e) => setPrompt(e.target.value)}
                                placeholder="Задай вопрос ИИ (например, Куда обратиться?)"
                                className="w-full p-2 bg-transparent text-neutral focus:outline-none"
                            />
                        </div>
                        <button
                            onClick={handleSubmit}
                            disabled={isLoading}
                            aria-label="Отправить запрос"
                            className={`p-2 bg-[var(--primary)] rounded-r transition-transform hover:scale-110 ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                            {isLoading ? (
                                <svg className="animate-spin h-8 w-8 text-neutral" fill="none" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" className="opacity-25" />
                                    <path fill="currentColor" d="M4 12a8 8 0 018-8v8z" className="opacity-75" />
                                </svg>
                            ) : (
                                <svg className="h-8 w-8 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            )}
                        </button>
                    </div>
                    <div className="text-center">
                        <button
                            onClick={() => setShowDetails(!showDetails)}
                            aria-expanded={showDetails}
                            className="text-sm text-[var(--primary)] hover:underline"
                        >
                            {showDetails ? 'скрыть ↑' : 'уточнить данные ↓'}
                        </button>
                        <p className="text-xs text-gray-600 mt-1">Заполните для более точных ответов</p>
                    </div>
                    {showDetails && (
                        <div className="details open space-y-3 mt-4 mb-4">
                            <div className="flex items-center">
                                <label htmlFor="name" className="sr-only">Имя</label>
                                <svg className="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <input
                                    id="name"
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="Имя (например, Анна)"
                                    className="w-full p-2 bg-transparent border border-gray-400 text-neutral rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                            </div>
                            <div className="flex items-center">
                                <label htmlFor="country" className="sr-only">Страна</label>
                                <svg className="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h18M3 3v18M21 3v18M9 9h6m-6 6h6" />
                                </svg>
                                <select
                                    id="country"
                                    value={country}
                                    onChange={(e) => setCountry(e.target.value)}
                                    className="w-full p-2 bg-transparent border border-gray-400 text-neutral rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                                >
                                    <option value="">Выберите страну</option>
                                    <option value="Испания">Испания</option>
                                    <option value="Германия">Германия</option>
                                    <option value="Россия">Россия</option>
                                    <option value="Франция">Франция</option>
                                </select>
                            </div>
                            <div className="flex items-center">
                                <label htmlFor="city" className="sr-only">Город</label>
                                <svg className="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7m-9 5v6h4v-6m-6-9h12" />
                                </svg>
                                <input
                                    id="city"
                                    type="text"
                                    value={city}
                                    onChange={(e) => setCity(e.target.value)}
                                    placeholder="Город (например, Мадрид)"
                                    className="w-full p-2 bg-transparent border border-gray-400 text-neutral rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                            </div>
                            <div className="flex items-center">
                                <label htmlFor="language" className="sr-only">Язык общения</label>
                                <svg className="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m-7 8h16" />
                                </svg>
                                <select
                                    id="language"
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    className="w-full p-2 bg-transparent border border-gray-400 text-neutral rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                                >
                                    <option value="">Выберите язык</option>
                                    <option value="Русский">Русский</option>
                                    <option value="Английский">Английский</option>
                                    <option value="Испанский">Испанский</option>
                                    <option value="Немецкий">Немецкий</option>
                                </select>
                            </div>
                            <button
                                onClick={resetData}
                                className="text-sm text-[var(--primary)] hover:underline"
                            >
                                Сбросить данные
                            </button>
                        </div>
                    )}
                    {response && (
                        <div className="p-3 bg-transparent border border-gray-400 text-neutral rounded mt-4">
                            <p><strong>Ответ:</strong> {response}</p>
                            {response.includes('Ошибка') && (
                                <button
                                    onClick={handleSubmit}
                                    className="text-sm text-[var(--primary)] hover:underline mt-2"
                                >
                                    Попробовать снова
                                </button>
                            )}
                        </div>
                    )}
                    {history.length > 0 && (
                        <div className="mt-4 p-3 bg-transparent border border-gray-400 text-neutral rounded">
                            <h2 className="text-lg font-semibold mb-2">История запросов</h2>
                            {history.slice(-5).reverse().map((item, index) => (
                                <div key={index} className="text-sm mb-2">
                                    <p><strong>Вопрос:</strong> {item.prompt}</p>
                                    <p><strong>Ответ:</strong> {item.response}</p>
                                </div>
                            ))}
                        </div>
                    )}
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        ReactDOM.render(<GobelinApp />, document.getElementById('root'));
    </script>
</body>
</html>
